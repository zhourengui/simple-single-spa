{"version":3,"file":"index.js","sources":["../../src/application/apps.helper.js","../../src/start.js","../../src/application/timeout.js","../../src/lifecycle/helper.js","../../src/lifecycle/load.js","../../src/lifecycle/bootstrap.js","../../src/lifecycle/unmount.js","../../src/lifecycle/mount.js","../../src/navigation/hijackLocation.js","../../src/navigation/invoke.js","../../src/application/apps.js"],"sourcesContent":["export const APPS = [];\n\nexport const NOT_LOADED = \"NOT_LOADED\";\nexport const NOT_MOUNTED = \"NOT_MOUNTED\";\nexport const SKIP_BECAUSE_BROKEN = \"SKIP_BECAUSE_BROKEN\";\nexport const LOAD_ERROR = \"LOAD_ERROR\";\nexport const LOAD_SOURCE_CODE = \"LOAD_SOURCE_CODE\";\nexport const NOT_BOOTSTRAPPED = \"NOT_BOOTSTRAPPED\";\nexport const BOOTSTRAPPED = \"BOOTSTRAPPED\";\nexport const MOUNTED = \"MOUNTED\";\nexport const LOAD_RESOURCE_CODE = \"LOAD_RESOURCE_CODE\";\nexport const UPDATING = \"UPDATING\";\n\nexport function noSkip(app) {\n  return app.status !== SKIP_BECAUSE_BROKEN;\n}\n\nexport function noLoadError(app) {\n  return app.status !== LOAD_ERROR;\n}\n\nexport function isntLoaded(app) {\n  return app.status === NOT_LOADED;\n}\n\nexport function isLoaded(app) {\n  return (\n    app.status !== NOT_LOADED &&\n    app.status !== SKIP_BECAUSE_BROKEN &&\n    app.status !== LOAD_ERROR\n  );\n}\n\nexport function isActivity(app) {\n  return app.status === MOUNTED;\n}\n\nexport function isntActivity(app) {\n  return !isActivity(app);\n}\n\nexport function shouldBeActivity(app) {\n  try {\n    return app.activityWhen(window.location);\n  } catch (error) {\n    app.status = SKIP_BECAUSE_BROKEN;\n  }\n}\n\nexport function shouldntBeActivity(app) {\n  try {\n    return !app.activityWhen(window.location);\n  } catch (error) {\n    app.status = SKIP_BECAUSE_BROKEN;\n  }\n}\n","import { invoke } from \"./navigation/invoke\";\n\nlet started = false;\n\nexport function start() {\n  if (started) return;\n  started = true;\n  invoke();\n}\n\nexport function isStart() {\n  return started;\n}\n","export const DEFAULT_TIMEOUTS = {\n  bootstrap: {\n    milliseconds: 3000,\n    rejectWhenTimeout: false,\n  },\n  mount: {\n    milliseconds: 3000,\n    rejectWhenTimeout: false,\n  },\n  unmount: {\n    milliseconds: 3000,\n    rejectWhenTimeout: false,\n  },\n};\n\nexport function reasonableTime(lifecycle, description, timeout) {\n  return new Promise((resolve, reject) => {\n    let finished = false;\n    lifecycle\n      .then(resolve)\n      .catch(reject)\n      .finally(() => (finished = true));\n\n    setTimeout(() => {\n      if (finished) return;\n\n      if (timeout.rejectWhenTimeout) {\n        reject(`${description}`);\n      } else {\n        console.log(\"timeout but waiting\");\n      }\n    }, timeout.milliseconds);\n  });\n}\n\nexport function ensureTimeout(timeouts = {}) {\n  return {\n    ...DEFAULT_TIMEOUTS,\n    ...timeouts,\n  };\n}\n","export function smellLikePromise(promise) {\n  if (promise instanceof Promise) {\n    return true;\n  }\n  return (\n    promise && typeof promise === \"object\" && typeof promise.then === \"function\"\n  );\n}\n\nexport function flattenLifecyclesArray(lifecycles, description) {\n  lifecycles = [].concat(lifecycles);\n\n  return function (props) {\n    return new Promise(async (resolve, reject) => {\n      let index = 0;\n      for await (const lifecycle of lifecycles) {\n        const lifecyclePromise = lifecycle(props);\n        if (!smellLikePromise(lifecyclePromise)) {\n          reject(new Error(`${description} has error`));\n          break;\n        }\n        try {\n          await lifecyclePromise;\n          index++;\n          if (index === lifecycles.length) {\n            resolve();\n          }\n        } catch (e) {\n          reject(e);\n          break;\n        }\n      }\n    });\n  };\n}\n\nexport function getProps(app) {\n  return {\n    name: app.name,\n    status: app.status,\n    ...app.customProps,\n  };\n}\n","import {\n  LOAD_SOURCE_CODE,\n  NOT_LOADED,\n  SKIP_BECAUSE_BROKEN,\n  NOT_BOOTSTRAPPED,\n  LOAD_ERROR,\n} from \"../application/apps.helper\";\nimport { ensureTimeout } from \"../application/timeout\";\nimport { flattenLifecyclesArray, smellLikePromise, getProps } from \"./helper\";\n\nexport async function toLoadPromise(app) {\n  if (app.status !== NOT_LOADED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = LOAD_SOURCE_CODE;\n\n  const loadPromise = app.loadFunction(getProps(app));\n\n  if (!smellLikePromise(loadPromise)) {\n    app.status = SKIP_BECAUSE_BROKEN;\n    return Promise.reject(\n      new Error(\"loadPromise must return a promise or a thenable object\")\n    );\n  }\n\n  return loadPromise\n    .then((appConfig) => {\n      if (typeof appConfig !== \"object\") {\n        throw new Error(\"\");\n      }\n\n      let errors = [];\n      [\"bootstrap\", \"mount\", \"unmount\"].forEach((lifecycle) => {\n        if (!appConfig[lifecycle]) {\n          errors.push(\"lifecycle: \" + lifecycle + \" must be exist\");\n        }\n      });\n\n      if (errors.length) {\n        app.status = SKIP_BECAUSE_BROKEN;\n        return app;\n      }\n\n      app.status = NOT_BOOTSTRAPPED;\n      app.bootstrap = flattenLifecyclesArray(\n        appConfig.bootstrap,\n        \"app: \" + app.name + \" bootstraping\"\n      );\n      app.mount = flattenLifecyclesArray(\n        appConfig.mount,\n        \"app: \" + app.name + \" mounting\"\n      );\n      app.unmount = flattenLifecyclesArray(\n        appConfig.unmount,\n        \"app: \" + app.name + \" unmounting\"\n      );\n      app.timeouts = ensureTimeout(appConfig.timeouts);\n    })\n    .catch((e) => {\n      console.error(e);\n      app.status = LOAD_ERROR;\n    })\n    .finally(() => {\n      return app;\n    });\n}\n","import {\n  BOOTSTRAPPED,\n  NOT_BOOTSTRAPPED,\n  NOT_MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n} from \"../application/apps.helper\";\nimport { reasonableTime } from \"../application/timeout\";\nimport { getProps } from \"./helper\";\n\nexport function toBootstrapPromise(app) {\n  if (app.status !== NOT_BOOTSTRAPPED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = BOOTSTRAPPED;\n\n  return reasonableTime(\n    app.bootstrap(getProps(app)),\n    `app: ${app.name} bootstraping`,\n    app.timeouts.bootstrap\n  )\n    .then(() => {\n      app.status = NOT_MOUNTED;\n      return app;\n    })\n    .catch((e) => {\n      app.status = SKIP_BECAUSE_BROKEN;\n      throw e;\n    });\n}\n","import {\n  MOUNTED,\n  NOT_MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n} from \"../application/apps.helper\";\nimport { reasonableTime } from \"../application/timeout\";\nimport { getProps } from \"./helper\";\n\nexport function toUnMountPromise(app) {\n  if (app.status !== MOUNTED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = NOT_MOUNTED;\n\n  return reasonableTime(\n    app.unmount(getProps(app)),\n    `app: ${app.name} unmounting`,\n    app.timeouts.unmount\n  )\n    .then(() => {\n      app.status = NOT_MOUNTED;\n      return app;\n    })\n    .catch((e) => {\n      app.status = SKIP_BECAUSE_BROKEN;\n      throw e;\n    });\n}\n","import {\n  MOUNTED,\n  NOT_MOUNTED,\n  SKIP_BECAUSE_BROKEN,\n} from \"../application/apps.helper\";\nimport { reasonableTime } from \"../application/timeout\";\nimport { getProps } from \"./helper\";\nimport { toUnMountPromise } from \"./unmount\";\n\nexport function toMountPromise(app) {\n  if (app.status !== NOT_MOUNTED) {\n    return Promise.resolve(app);\n  }\n\n  app.status = MOUNTED;\n  return reasonableTime(\n    app.mount(getProps(app)),\n    `app: ${app.name} mounting`,\n    app.timeouts.mount\n  )\n    .then(() => {\n      app.status = MOUNTED;\n      return app;\n    })\n    .catch((e) => {\n      app.status = SKIP_BECAUSE_BROKEN;\n      toUnMountPromise(app);\n      console.log(e);\n    });\n}\n","import { invoke } from \"./invoke\";\n\nconst HIJACK_EVENTS_NAME = /^(hashchange|popstate)&/i;\nconst EVENTS_POOL = {\n  hashchange: [],\n  popstate: [],\n};\n\nexport function reroute() {\n  invoke([], arguments);\n}\n\nwindow.addEventListener(\"hashchange\", reroute);\nwindow.addEventListener(\"popstate\", reroute);\n\nconst originalAddEventListener = window.addEventListener;\nconst originalRemoveEventListener = window.removeEventListener;\n\nwindow.addEventListener = function (eventName, handler) {\n  if (\n    eventName &&\n    HIJACK_EVENTS_NAME.test(eventName) &&\n    typeof handler === \"function\"\n  ) {\n    EVENTS_POOL[eventName].indexOf(handler) === -1 &&\n      EVENTS_POOL[eventName].push(handler);\n    return;\n  }\n\n  originalAddEventListener.apply(this, arguments);\n};\n\nwindow.removeEventListener = function (eventName, handler) {\n  if (\n    eventName &&\n    HIJACK_EVENTS_NAME.test(eventName) &&\n    typeof handler === \"function\"\n  ) {\n    let eventList = EVENTS_POOL[eventName];\n    eventList.indexOf(handler) > -1 &&\n      (EVENTS_POOL[eventName] = eventList.filter((fn) => fn !== handler));\n    return;\n  }\n  originalRemoveEventListener.apply(this, arguments);\n};\n\nfunction mockPopStateEvent(state) {\n  return new PopStateEvent(state);\n}\n\nconst originalPushState = window.history.pushState;\nconst originalReplaceState = window.history.replaceState;\n\nwindow.history.pushState = function (state, title, url) {\n  const res = originalPushState.apply(this, arguments);\n  reroute(mockPopStateEvent(state));\n  return res;\n};\n\nwindow.history.replaceState = function (state, title, url) {\n  const res = originalReplaceState.apply(this, arguments);\n  reroute(mockPopStateEvent(state));\n  return res;\n};\n\nexport function callCapturedEvents(eventsArgs) {\n  if (!eventsArgs) {\n    return;\n  }\n\n  eventsArgs = [].concat(eventsArgs);\n\n  if (!EVENTS_POOL[eventsArgs[0].type]) {\n    return;\n  }\n\n  EVENTS_POOL[eventsArgs[0].type].forEach((handler) => {\n    handler.apply(null, eventsArgs);\n  });\n}\n","import { isStart } from \"../start\";\nimport {\n  getAppsToLoad,\n  getAppsToMount,\n  getAppsToUnMount,\n  getMountedApps,\n} from \"../application/apps\";\nimport { toLoadPromise } from \"../lifecycle/load\";\nimport { toBootstrapPromise } from \"../lifecycle/bootstrap\";\nimport { toUnMountPromise } from \"../lifecycle/unmount\";\nimport { toMountPromise } from \"../lifecycle/mount\";\nimport { callCapturedEvents } from \"./hijackLocation\";\n\nlet loadAppsUnderway = false;\nlet pendingPromises = [];\n\nexport function invoke(pendings = [], eventArgs) {\n  if (loadAppsUnderway) {\n    // 正在循环\n    return new Promise((resolve, reject) => {\n      pendingPromises.push({\n        success: resolve,\n        failure: reject,\n      });\n    });\n  }\n\n  loadAppsUnderway = true;\n\n  return isStart() ? performAppChanges() : loadApps();\n\n  function loadApps() {\n    // 预加载\n    return Promise.all(getAppsToLoad().map(toLoadPromise))\n      .then(() => {\n        callAllLocationEvents();\n        return finish();\n      })\n      .catch((e) => {\n        callAllLocationEvents();\n        console.log(e);\n      });\n  }\n\n  function performAppChanges() {\n    const unMountApps = getAppsToUnMount();\n    const unmountPromises = Promise.all(unMountApps.map(toUnMountPromise));\n\n    const loadApps = getAppsToLoad();\n    const loadPromises = loadApps.map((app) =>\n      toLoadPromise(app)\n        .then(() => toBootstrapPromise(app))\n        .then(() => unmountPromises)\n        .then(() => toMountPromise(app))\n    );\n\n    const mountApps = getAppsToMount().filter(\n      (app) => loadApps.indexOf(app) === -1\n    );\n\n    const mountPromises = mountApps.map((app) => {\n      toBootstrapPromise(app)\n        .then(() => unmountPromises)\n        .then(() => toMountPromise(app));\n    });\n\n    return unmountPromises\n      .then(() => {\n        callAllLocationEvents();\n        Promise.all(loadPromises.concat(mountPromises))\n          .then(finish)\n          .catch((e) => {\n            pendings.forEach((item) => item.reject(e));\n            finish();\n          });\n      })\n      .catch((e) => {\n        callAllLocationEvents();\n        throw e;\n      });\n  }\n\n  function finish() {\n    const res = getMountedApps();\n\n    pendings.forEach((item) => item.success(res));\n\n    loadAppsUnderway = false;\n    if (pendingPromises.length) {\n      let backup = pendingPromises;\n      pendingPromises = [];\n      return invoke(backup);\n    }\n\n    return res;\n  }\n\n  function callAllLocationEvents() {\n    pendings\n      .filter((item) => !!item.eventArgs)\n      .forEach((item) => callCapturedEvents(item.eventArgs));\n\n    eventArgs && callCapturedEvents(eventArgs);\n  }\n}\n","import {\n  NOT_LOADED,\n  APPS,\n  noSkip,\n  noLoadError,\n  isntLoaded,\n  shouldBeActivity,\n  isActivity,\n  shouldntBeActivity,\n  isLoaded,\n  isntActivity,\n} from \"./apps.helper\";\nimport { invoke } from \"../navigation/invoke\";\n\n/**\n * 注册app\n * @param {string} appName 注册的app名称\n * @param {Function<Promise>|Object} loadFunction app异步加载函数或app内容\n * @param {Function<Boolean>} activityWhen 判断app什么时候启动\n * @param {Object} customProps 自定义配置\n * @return {Promise}\n */\nexport function registerApplication(\n  appName,\n  loadFunction,\n  activityWhen,\n  customProps = {}\n) {\n  if (!appName && typeof appName !== \"string\") {\n    throw new TypeError(\"appName must be a non-empty string\");\n  }\n\n  if (!loadFunction) {\n    throw new TypeError(\"loadFunction must be a function or object\");\n  }\n\n  if (typeof loadFunction !== \"function\") {\n    loadFunction = () => Promise.resolve(loadFunction);\n  }\n\n  if (typeof activityWhen !== \"function\") {\n    throw new TypeError(\"activityWhen must be a function\");\n  }\n\n  APPS.push({\n    name: appName,\n    loadFunction,\n    activityWhen,\n    customProps,\n    status: NOT_LOADED,\n  });\n\n  invoke();\n}\n\nexport function getAppsToLoad() {\n  return APPS.filter(noSkip)\n    .filter(noLoadError)\n    .filter(isntLoaded)\n    .filter(shouldBeActivity);\n}\n\nexport function getAppsToUnMount() {\n  return APPS.filter(noSkip).filter(isActivity).filter(shouldntBeActivity);\n}\n\nexport function getAppsToMount() {\n  return APPS.filter(noSkip)\n    .filter(isLoaded)\n    .filter(isntActivity)\n    .filter(shouldBeActivity);\n}\n\nexport function getMountedApps() {\n  return APPS.filter(isActivity);\n}\n"],"names":["APPS","NOT_LOADED","NOT_MOUNTED","SKIP_BECAUSE_BROKEN","LOAD_ERROR","LOAD_SOURCE_CODE","NOT_BOOTSTRAPPED","BOOTSTRAPPED","MOUNTED","noSkip","app","status","noLoadError","isntLoaded","isLoaded","isActivity","isntActivity","shouldBeActivity","activityWhen","window","location","error","shouldntBeActivity","started","start","invoke","isStart","DEFAULT_TIMEOUTS","bootstrap","milliseconds","rejectWhenTimeout","mount","unmount","reasonableTime","lifecycle","description","timeout","Promise","resolve","reject","finished","then","catch","finally","setTimeout","console","log","ensureTimeout","timeouts","smellLikePromise","promise","flattenLifecyclesArray","lifecycles","concat","props","index","lifecyclePromise","Error","length","e","getProps","name","customProps","toLoadPromise","loadPromise","loadFunction","appConfig","errors","forEach","push","toBootstrapPromise","toUnMountPromise","toMountPromise","HIJACK_EVENTS_NAME","EVENTS_POOL","hashchange","popstate","reroute","arguments","addEventListener","originalAddEventListener","originalRemoveEventListener","removeEventListener","eventName","handler","test","indexOf","apply","eventList","filter","fn","mockPopStateEvent","state","PopStateEvent","originalPushState","history","pushState","originalReplaceState","replaceState","title","url","res","callCapturedEvents","eventsArgs","type","loadAppsUnderway","pendingPromises","pendings","eventArgs","success","failure","performAppChanges","loadApps","all","getAppsToLoad","map","callAllLocationEvents","finish","unMountApps","getAppsToUnMount","unmountPromises","loadPromises","mountApps","getAppsToMount","mountPromises","item","getMountedApps","backup","registerApplication","appName","TypeError"],"mappings":"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"}